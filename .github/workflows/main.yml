name: Build BMAT_CC (Draft Release)

on:
  push:
    tags:
      - "v*" # Trigger by pushing a tag (e.g., git tag v1.0.0)

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Install PS2EXE
        shell: pwsh
        run: |
          Install-Module ps2exe -Scope CurrentUser -Force -AllowClobber

      - name: Set Version
        id: version_step
        shell: pwsh
        run: |
          $version = "${{ github.ref_name }}".TrimStart('v')
          Add-Content -Path $env:GITHUB_ENV -Value "VERSION=$version"

      - name: Build EXE
        shell: pwsh
        run: |
          ps2exe `
            -inputFile BMAT_CC.ps1 `
            -outputFile BMAT_CC.exe `
            -iconFile BMAT_CC.ico `
            -title "BMAT CC" `
            -description "BA2 Automation Tool for CC Mods" `
            -company "RJDevDen" `
            -product "BMAT CC" `
            -copyright "Â© 2025-2026 RJ" `
            -trademark "BMAT CC" `
            -version ${{ env.VERSION }} `
            -requireAdmin:$false `
            -noConsole:$false

      - name: Import Code Signing Certificate
        shell: pwsh
        run: |
          $pfx = [Convert]::FromBase64String("${{ secrets.CODESIGN_PFX_BASE64 }}")
          $path = "$env:TEMP\codesign.pfx"
          [IO.File]::WriteAllBytes($path, $pfx)

          Import-PfxCertificate `
            -FilePath $path `
            -CertStoreLocation Cert:\CurrentUser\My `
            -Password (ConvertTo-SecureString "${{ secrets.CODESIGN_PASSWORD }}" -AsPlainText -Force)

      - name: Sign EXE
        shell: pwsh
        run: |
          $Certificate = Get-ChildItem Cert:\CurrentUser\My | Where-Object { $_.Subject -match "RJDevDen" }
          Set-AuthenticodeSignature -FilePath "BMAT_CC.exe" -Certificate $Certificate

      - name: Set Release Filename
        id: filename_step
        shell: pwsh
        run: |
          $date = Get-Date -Format "ddMMyyyy"
          $finalName = "BMAT_CC_${date}_${{ env.VERSION }}"
          Add-Content -Path $env:GITHUB_ENV -Value "RELEASE_NAME=$finalName"

      - name: Assemble Folder Structure
        shell: pwsh
        run: |
          $bundlePath = "staging/Data/Tools/BMAT_CC"
          New-Item -ItemType Directory -Path "$bundlePath/BSArch" -Force
          Copy-Item -Path "BMAT_CC.exe" -Destination "$bundlePath/"
          Copy-Item -Path "BSArch/BSArch.exe" -Destination "$bundlePath/BSArch/"
          Compress-Archive -Path "staging/*" -DestinationPath "${{ env.RELEASE_NAME }}.zip"

      - name: Create Private Draft Release
        uses: softprops/action-gh-release@v2
        with:
          files: "${{ env.RELEASE_NAME }}.zip"
          draft: true
          name: "BMAT_CC ${{ github.ref_name }}"
          body: "Automated Build: ${{ env.RELEASE_NAME }}.zip"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
